name: CI/CD for Flask Encryption App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run application tests
      run: |
        python test_deployment.py
    
    - name: Test Flask app startup
      run: |
        python -c "
        import sys
        sys.path.append('.')
        from app import app
        print('âœ… Flaskåº”ç”¨å¯åŠ¨æµ‹è¯•é€šè¿‡')
        "
    
    - name: Test all imports
      run: |
        python -c "
        import sys
        sys.path.append('.')
        
        # æµ‹è¯•æ‰€æœ‰å¿…è¦çš„å¯¼å…¥
        from config import Config
        from utils.encryption_engine import EncryptionEngine
        from utils.file_processor import FileProcessor
        from utils.password_book import PasswordBookManager
        
        print('âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸ')
        
        # æµ‹è¯•é…ç½®
        assert hasattr(Config, 'SECRET_KEY'), 'ç¼ºå°‘SECRET_KEYé…ç½®'
        assert hasattr(Config, 'UPLOAD_FOLDER'), 'ç¼ºå°‘UPLOAD_FOLDERé…ç½®'
        print('âœ… é…ç½®æ£€æŸ¥é€šè¿‡')
        "

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install gunicorn
    
    - name: Create deployment structure
      run: |
        # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
        mkdir -p static/uploads static/password_books
        
        # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒå¯åŠ¨è„šæœ¬
        cat > start_production.sh << 'EOF'
        #!/bin/bash
        # ç”Ÿäº§çŽ¯å¢ƒå¯åŠ¨è„šæœ¬
        export SECRET_KEY=${SECRET_KEY:-"production-secret-key"}
        gunicorn --bind 0.0.0.0:$PORT --workers 4 --threads 2 --timeout 120 app:app
        EOF
        chmod +x start_production.sh
        
        # åˆ›å»ºç®€å•çš„éƒ¨ç½²è¯´æ˜Ž
        cat > DEPLOY_QUICKSTART.md << 'EOF'
        # å¿«é€Ÿéƒ¨ç½²æŒ‡å—
        
        ## çŽ¯å¢ƒå˜é‡
        - SECRET_KEY: Flaskåº”ç”¨å¯†é’¥
        - PORT: æœåŠ¡ç«¯å£
        
        ## å¯åŠ¨å‘½ä»¤
        ```bash
        # å¼€å‘çŽ¯å¢ƒ
        python app.py
        
        # ç”Ÿäº§çŽ¯å¢ƒ
        ./start_production.sh
        ```
        
        ## æ”¯æŒçš„å¹³å°
        - Heroku: ä½¿ç”¨Procfile
        - Railway: è‡ªåŠ¨æ£€æµ‹Pythonåº”ç”¨
        - PythonAnywhere: é…ç½®WSGIæŒ‡å‘wsgi.py
        - Vercel: éœ€è¦serverlessé€‚é…
        EOF
    
    - name: Create deployment package
      uses: actions/upload-artifact@v4
      with:
        name: flask-encryption-app-deployment
        path: |
          .
          !.git
          !.github
        retention-days: 30
    
    - name: Display deployment info
      run: |
        echo "ðŸš€ åº”ç”¨æž„å»ºå®Œæˆï¼"
        echo "ðŸ“¦ éƒ¨ç½²åŒ…å·²åˆ›å»º"
        echo "ðŸ”§ æ”¯æŒå¹³å°: Heroku, Railway, PythonAnywhere"
        echo "ðŸ“š æŸ¥çœ‹ DEPLOY_QUICKSTART.md èŽ·å–éƒ¨ç½²è¯´æ˜Ž"